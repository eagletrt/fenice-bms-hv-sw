# OpenBLT

[OpenBLT](https://www.feaser.com/openblt/doku.php) is an open source bootloader that can run on any microcontroller and use any type of communication interface to perform **software updates**, without the need of specialized debugger hardware

Both cellboards' and mainboard's bootloaders are derived from [OpenBLT sources](https://github.com/feaser/openblts)

## Mainboard and Cellboard bootloaders

The `openblt_mainboard` and `openblt_cellboard` folders contains the actual code of the bootloader which has to be flashed to the microcontroller in order to be able to load your program via the desired communication protocol

Each project is generated by `STM32CubeMX` except the `BLT` folder which containts all the necessary sources of OpenBLT, that can be found in it's github repository either in the `Target/Source`, `Target/Source/_template` or `Target/Demo/_template/Boot` folders

The whole bootloader configuration happens in the `blt_conf.h` header file, exception made for the `flashLayout[]` variable in `flash.c`, where the flash layout is specified

---

## Flash via CAN procedure

### Building and flashing the bootloader

Being an `STM32CubeMX` projects, building and flashing the bootloader is straightforward.

### Building the firmware

In order to operate with the bootloader you need to **modify the linker file** (`*_FLASH.ld` in the root directory of your project)

In particular you need to change the `FLASH (rx)` line in the `MEMORY` segment:
   - Change the origin address according to what has been specified in the previously mentioned `flash.c` file (eg. `ORIGIN = 0x8004000`)
   - Change the length of the flash memory in order to match with the specified address (eg. `LENGTH = 496K`)

### Preparing the binaries

In order to send the binaries via CAN they have to be converted to the `.srec` format

This can be achieved with this tool: [arkku/srec](https://github.com/arkku/srec)

*Example*:
```bash
bin2srec -a 0x8004000 -i *.bin -o *.srec
```
---

### Flashing the firmware

The last step requires:
1. A device **directly connected** to the CAN, like telemetry's and steering wheel's Raspberries
2. [Can-utils](https://elinux.org/Can-utils) installed in the device
3. [Bootcommander](https://www.feaser.com/openblt/doku.php?id=manual:bootcommander) installed in the device

When everything is ready the project can be flashed by resetting the microcontroller (via an appropriate *CAN message*)
and then sending the program to flash using the **bootcommander** tool, with:
- The `-t` flag set to `xcp_can`
- The selected CAN peripheral (`-d` flag)
- The *baud rate* (`-b` flag)
- The transmission ID (`-tid` flag) and the reception ID (`-rid` flag)
- The **binary executable** converted to the `.srec` format

*Example*:
```bash
cansend can1 005#00 &&
bootcommander -t=xcp_can -d=can1 -b=1000000 -tid=667 -rid=7E1 fenice-bms.srec
```